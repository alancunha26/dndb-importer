# RFC 0001: D&D Beyond HTML to Markdown Converter

**Status:** Accepted

**Author:** Alan Cunha

**Created:** 2025-11-15

**Updated:** 2025-11-15

## Summary

A CLI tool that converts D&D Beyond sourcebook HTML pages into clean, structured Markdown files with unique ID-based file naming, local image downloading, navigation links, and D&D-specific formatting preservation (stat blocks, spell descriptions, tables).

## Motivation

### Goals

- Convert D&D Beyond HTML sourcebooks to Markdown format
- Preserve content hierarchy and structure
- Handle D&D-specific formatting (stat blocks, tables, spell descriptions, etc.)
- Maintain relative file organization per sourcebook
- Provide a simple, intuitive CLI interface
- Generate unique IDs for files and images to avoid naming conflicts
- Create navigation links between related content
- Download and organize images locally

### Non-Goals

- Automated downloading from D&D Beyond (users manually download)
- Real-time conversion or web scraping
- PDF generation or other output formats (for now)

## Proposal

### High-Level Architecture

```
┌─────────────────┐
│   CLI Entry     │
│   Point         │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Configuration  │
│  Loader         │
└────────┬────────┘
         │
         ▼
┌─────────────────┐      ┌──────────────────┐
│  File Scanner   │─────▶│  ID Generator    │
│  & Validator    │      │  (short-uuid)    │
└────────┬────────┘      └──────────────────┘
         │
         ▼
┌─────────────────┐      ┌──────────────────┐
│  HTML Parser    │─────▶│  Turndown Core   │
│  & Processor    │      │  + Custom Rules  │
└────────┬────────┘      └──────────────────┘
         │                        │
         │                        ▼
         │               ┌──────────────────┐
         │               │  Cross-Reference │
         │               │  Converter       │
         │               └──────────────────┘
         │
         ├────────────────────────┐
         ▼                        ▼
┌─────────────────┐      ┌──────────────────┐
│  Image          │      │  Markdown        │
│  Downloader     │─────▶│  Post-Processor  │
└─────────────────┘      └────────┬─────────┘
                                  │
                                  ▼
                         ┌──────────────────┐
                         │  Navigation      │
                         │  Builder         │
                         └────────┬─────────┘
                                  │
                                  ▼
┌─────────────────┐      ┌──────────────────┐
│  File Writer    │─────▶│  Index           │
│  & Organizer    │      │  Generator       │
└─────────────────┘      └──────────────────┘
```

### User Experience

**CLI Commands:**

```bash
# Convert all books in input directory
dndb-convert --input ./input --output ./output

# Convert specific book
dndb-convert --input ./input/players-handbook --output ./output

# Dry run (preview without writing)
dndb-convert --input ./input --dry-run

# Verbose output
dndb-convert --input ./input --output ./output --verbose

# Custom config
dndb-convert --input ./input --output ./output --config custom.json
```

**Directory Structure:**

```
my-dndbeyond-books/
├── input/
│   ├── players-handbook/
│   │   ├── 01-introduction.html
│   │   ├── 02-chapter-1.html
│   │   └── 03-chapter-2.html
│   └── dungeon-masters-guide/
│       └── 01-chapter-1.html
└── output/
    ├── players-handbook/
    │   ├── m3x7.png             # Downloaded images with unique IDs
    │   ├── p4q2.jpg
    │   ├── k2p8.md              # Index file
    │   ├── a3f9.md              # Introduction
    │   └── m5x1.md              # Chapter 1
    └── dungeon-masters-guide/
        ├── j4uv.md              # Index file
        └── yg6c.md              # Chapter 1
```

**Output File Format:**

Each markdown file contains:

- YAML front matter (title, date, tags)
- Navigation header (prev | index | next)
- Content converted from HTML
- Image references using unique IDs (e.g., `![Alt](m3x7.png)`)

## Design Details

### Architecture Decisions

**File Naming & IDs:**

- Use unique 4-character IDs generated by `short-unique-id` library
- Format: lowercase alphanumeric only (e.g., `a3f9.md`, `k2p8.md`)
- Images also use unique IDs (e.g., `m3x7.png`, `p4q2.jpg`)
- Images saved in same directory as markdown files

**Navigation & Structure:**

- Create one index file per sourcebook with ordered links
- Add previous/index/next navigation header to each file
- Index files link to all content in order

**YAML Front Matter:**

- Simplified format with title, date, and tags
- Two tag types:
  - `dnd5e/chapter` - for source sections/chapters
  - `dnd5e/source` - for source index files

**Content Handling:**

- **Headings**: Preserve source heading levels (don't normalize)
- **Cross-References**: Replace entity links (spells, monsters, equipment) with bold text
- **Images**: Download images locally and name with unique IDs
- **Duplicate Content**: Repeat content if it appears in multiple files

**File Ordering:**

- Use numeric prefix in filenames (e.g., `01-introduction.html`, `02-chapter-1.html`)
- Scanner sorts by numeric prefix, falls back to alphabetical

### Core Components

#### 1. File Scanner (`src/scanner.ts`)

- Discovers HTML files in input directory
- Generates unique 4-character IDs for each file using `short-unique-id`
- Groups files by sourcebook
- Creates file processing queue ordered by numeric prefix
- Generates unique ID for sourcebook index files

#### 2. HTML Parser & Preprocessor (`src/html-processor.ts`)

- Loads HTML files
- Cleans up unnecessary elements (scripts, styles, navigation)
- Identifies D&D-specific structures
- Extracts metadata (title, chapter, page references)
- Removes D&D Beyond chrome (nav bars, ads, login prompts)

#### 3. Turndown Converter with Custom Rules (`src/turndown/`)

- Converts HTML to Markdown
- Applies D&D-specific formatting rules:
  - **Stat Blocks**: Monster/NPC stat blocks with proper formatting
  - **Spell Blocks**: Spell descriptions with standard format
  - **Tables**: Equipment tables, spell lists, encounter tables
  - **Sidebars/Callouts**: Block quotes for variant rules
  - **Cross-References**: Convert entity links to bold text

#### 4. Markdown Post-Processor (`src/markdown-writer.ts`)

- Cleans up Turndown output
- Generates navigation headers
- Adds YAML front matter
- Handles cross-references to entities
- Updates image paths to use unique ID filenames

#### 5. Image Downloader & Processor (`src/image-handler.ts`)

- Detects images in HTML content
- Downloads images from URLs
- Generates unique IDs for image filenames
- Saves images to sourcebook directory
- Tracks image mappings (original URL → unique ID)

#### 6. File Writer & Organizer

- Creates output directory structure
- Writes Markdown files with unique ID filenames
- Generates sourcebook index files
- Preserves relative paths
- Tracks file ordering for navigation

### Technology Stack

**Core Dependencies:**

- Node.js (v18+)
- TypeScript (v5+)
- Turndown - HTML to Markdown conversion
- Cheerio - HTML parsing and manipulation
- Commander.js - CLI argument parsing
- Chalk - Terminal styling and colors
- Ora - Progress spinners
- Fast-glob - File pattern matching
- short-unique-id - Unique ID generation
- axios - Image downloading
- env-paths - Cross-platform config paths (XDG on Linux)

**Development Dependencies:**

- esbuild - Production bundling and builds
- tsx - TypeScript execution for development
- Jest or Vitest - Testing
- ESLint + @typescript-eslint/\* - Linting
- Prettier - Code formatting

### Type Definitions

All types consolidated in `src/types.ts`:

```typescript
export interface FileDescriptor {
  sourcePath: string;
  relativePath: string;
  outputPath: string;
  sourcebook: string;
  filename: string;
  uniqueId: string; // 4-character unique ID
}

export interface ImageDescriptor {
  originalUrl: string;
  uniqueId: string;
  extension: string;
  localPath: string;
  sourcebook: string;
  downloadStatus: "pending" | "success" | "failed";
  error?: Error;
}

export interface NavigationLinks {
  previous?: { title: string; id: string };
  index: { title: string; id: string };
  next?: { title: string; id: string };
}

export interface ConversionResult {
  markdown: string;
  metadata: DocumentMetadata;
  navigation: NavigationLinks;
  images: ImageDescriptor[];
  warnings: string[];
}
```

### Configuration

**Layered Configuration System:**

The tool uses a three-tier configuration priority:
1. **Default config** - Built-in defaults from `src/config/default.json`
2. **User config** - OS-specific user configuration (optional)
3. **Custom config** - CLI `--config` flag (highest priority)

**OS-Specific Config Paths (using env-paths):**

- **Linux:** `$XDG_CONFIG_HOME/dndbeyond-importer/config.json` (defaults to `~/.config/dndbeyond-importer/config.json`)
  - Follows XDG Base Directory specification
- **macOS:** `~/Library/Preferences/dndbeyond-importer/config.json`
- **Windows:** `%APPDATA%\dndbeyond-importer\config.json`

**Configuration Sections:**

- Input/output directories
- Turndown conversion options
- D&D Beyond specific cleanup
- Media handling
- Cross-reference conversion
- Logging preferences

Configs are deep-merged, allowing partial overrides while preserving defaults.

### Error Handling

**Error Categories:**

1. File System Errors (directory not found, permissions)
2. Parsing Errors (malformed HTML, unexpected structure)
3. Conversion Errors (Turndown failures, custom rule exceptions)
4. Write Errors (output directory creation, file permissions)

**Strategy:**

- Fail Fast: Critical errors (config issues, input not found) stop execution
- Graceful Degradation: Per-file errors log and continue to next file
- Detailed Logging: All errors logged with context
- Summary Report: End-of-run summary showing successes and failures
- Image Download Errors: Retry with exponential backoff (3 attempts), generate JSON report for persistent failures

## Alternatives Considered

### Alternative 1: Normalized Heading Levels

**Considered:** Normalizing all heading levels to start at H1 for consistency.
**Rejected:** Preserving source heading levels maintains the original document structure and hierarchy.

### Alternative 2: Keep Cross-Reference Links

**Considered:** Keeping entity cross-reference links as markdown links.
**Rejected:** Bold text matches PDF style and avoids broken links in the offline markdown format.

### Alternative 3: Image Subdirectory

**Considered:** Storing images in a separate `images/` subdirectory.
**Rejected:** Keeping images in the same directory as markdown files simplifies references and organization.

### Alternative 4: Descriptive Filenames

**Considered:** Using descriptive filenames based on chapter titles (e.g., `chapter-1-character-creation.md`).
**Rejected:** Unique IDs are more robust, avoid filename conflicts, and prevent issues with special characters or long titles.

### Alternative 5: Sequential Numeric IDs

**Considered:** Using sequential numbers (001, 002, etc.) for file IDs.
**Rejected:** Short unique IDs are more flexible, avoid renumbering when files are added/removed, and provide better collision resistance.

### Alternative 6: Manual OS Detection for Config Paths

**Considered:** Manually detecting OS and building config paths with custom logic.
**Rejected:** Using `env-paths` library provides:
- Automatic XDG Base Directory specification compliance on Linux
- Platform-specific conventions (macOS Preferences, Windows AppData)
- Tested and maintained cross-platform behavior
- Environment variable support (e.g., `$XDG_CONFIG_HOME`)

## Open Questions

- [x] Should we use unique IDs or descriptive filenames? → **Decision: Unique 4-character IDs**
- [x] Should images be in a subdirectory or same directory as markdown? → **Decision: Same directory**
- [x] How should cross-references to entities be handled? → **Decision: Convert to bold text**
- [x] What tag structure should we use in YAML front matter? → **Decision: `dnd5e/chapter` and `dnd5e/source`**
- [x] Which build tool should we use for production? → **Decision: esbuild**
- [x] Which HTML parser should we use (JSDOM vs Cheerio)? → **Decision: Cheerio (simpler and faster)**
- [x] Which CLI framework should we use (Commander.js vs Yargs)? → **Decision: Commander.js + Chalk**
- [x] How should we handle errors during image downloads? → **Decision: Retry 3 times with backoff, generate JSON report for failures**
- [x] Should we support batch processing with parallel conversion? → **Decision: No parallel processing in Phase 1, sequential file processing**

## Implementation Phases

### Phase 1 (MVP)

- Basic HTML to Markdown conversion
- Custom rules for stat blocks, spells, tables
- CLI interface with essential options (Commander.js + Chalk)
- Sequential file processing (no parallelization)
- Unique ID generation for files and images
- Image downloading with retry logic and failure reporting (JSON)
- Navigation links
- Index file generation

### Phase 2 (Enhancements)

- Parallel processing of files
- Better cross-reference handling
- Generate table of contents
- Plugin system for custom rules
- Watch mode for automatic conversion

### Phase 3 (Advanced)

- Support for other VTT HTML exports
- Interactive mode for handling ambiguous structures
- Advanced metadata extraction
- Export to other formats (Obsidian, Notion, etc.)

## Success Criteria

- ✅ Converts HTML files to readable Markdown
- ✅ Preserves directory structure (one folder per sourcebook)
- ✅ Generates unique 4-character IDs for all files
- ✅ Generates unique 4-character IDs for all images
- ✅ Downloads images and saves to same directory as markdown files
- ✅ Image references use simple filenames
- ✅ Creates navigation headers with previous/index/next links
- ✅ Generates index file per sourcebook with ordered links
- ✅ Uses correct tags (`dnd5e/chapter` and `dnd5e/source`)
- ✅ Converts entity cross-references to bold text
- ✅ Preserves source heading levels
- ✅ Stat blocks are properly formatted
- ✅ Tables are preserved and readable
- ✅ Spell blocks follow consistent format
- ✅ CLI is intuitive and provides helpful feedback
- ✅ Handles errors gracefully without data loss
- ✅ Processes entire sourcebook without manual intervention

## References

- [Turndown](https://github.com/mixmark-io/turndown) - HTML to Markdown converter
- [short-unique-id](https://github.com/jeanlescure/short-unique-id) - Unique ID generation
- [JSDOM](https://github.com/jsdom/jsdom) - HTML parsing option
- [Cheerio](https://github.com/cheeriojs/cheerio) - HTML parsing option
- [Commander.js](https://github.com/tj/commander.js) - CLI framework option
- [Yargs](https://github.com/yargs/yargs) - CLI framework option
